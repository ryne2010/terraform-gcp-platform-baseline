name: gcp-terraform-deploy-dev

on:
  workflow_run:
    workflows: ["terraform-ci"]
    types: [completed]

jobs:
  deploy:
    # Deploy only after CI succeeds on main.
    if: >-
      ${{ github.event.workflow_run.conclusion == 'success' &&
          github.event.workflow_run.head_branch == 'main' &&
          vars.GCP_WIF_PROVIDER != '' &&
          vars.GCP_WIF_SERVICE_ACCOUNT != '' &&
          vars.GCP_TF_CONFIG_GCS_PATH != '' }}

    runs-on: ubuntu-latest
    environment: dev
    concurrency:
      group: gcp-terraform-deploy-dev
      cancel-in-progress: true
    permissions:
      contents: read
      id-token: write

    env:
      TF_DIR: examples/grounded_knowledge_demo

      TF_CONFIG_GCS_PATH: ${{ vars.GCP_TF_CONFIG_GCS_PATH }}
      GCP_WIF_PROVIDER: ${{ vars.GCP_WIF_PROVIDER }}
      GCP_WIF_SERVICE_ACCOUNT: ${{ vars.GCP_WIF_SERVICE_ACCOUNT }}

    steps:
      - name: Assert required GitHub Environment variables
        shell: bash
        run: |
          set -euo pipefail
          test -n "${GCP_WIF_PROVIDER}" || { echo "::error::Missing env var: GCP_WIF_PROVIDER"; exit 1; }
          test -n "${GCP_WIF_SERVICE_ACCOUNT}" || { echo "::error::Missing env var: GCP_WIF_SERVICE_ACCOUNT"; exit 1; }
          test -n "${TF_CONFIG_GCS_PATH}" || { echo "::error::Missing env var: GCP_TF_CONFIG_GCS_PATH"; exit 1; }
          echo "Terraform root: ${TF_DIR}"
          echo "Terraform config path: ${TF_CONFIG_GCS_PATH}"

      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Auth to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.GCP_WIF_PROVIDER }}
          service_account: ${{ env.GCP_WIF_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Fetch Terraform config from GCS
        shell: bash
        run: |
          set -euo pipefail
          echo "Fetching Terraform config from: ${TF_CONFIG_GCS_PATH}"
          gcloud storage cp "${TF_CONFIG_GCS_PATH}/backend.hcl" "${TF_DIR}/backend.hcl"
          gcloud storage cp "${TF_CONFIG_GCS_PATH}/terraform.tfvars" "${TF_DIR}/terraform.tfvars"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.5

      - name: Terraform init (remote state)
        shell: bash
        run: |
          set -euo pipefail
          terraform -chdir="${TF_DIR}" init -reconfigure -backend-config="backend.hcl"

      - name: Terraform plan (for traceability)
        shell: bash
        run: |
          set -euo pipefail
          terraform -chdir="${TF_DIR}" plan -out=tfplan

      - name: Terraform apply
        shell: bash
        run: |
          set -euo pipefail
          terraform -chdir="${TF_DIR}" apply -auto-approve tfplan
